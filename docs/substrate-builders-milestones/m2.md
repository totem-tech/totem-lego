# Totem Technical Milestone - M2

**This specification is for the deliverables in the Substrate Builders Program.**

_It should be noted that as Totem has been building for more than two years on Substrate, the milestones should be viewed in the context of the considerable work that has already been developed, and these deliverables are part of an on-going 3 year roadmap._

The background to the project and functional documentation can be found [https://docs.totemaccounting.com](https://docs.totemaccounting.com).

The Substrate code is available at [https://rustdocs.totemaccounting.com](https://rustdocs.totemaccounting.com).

## Overview of tasks M2 Substrate Builders Program

---

For this Milestone the technical tasks are to develop unit tests for each of the public facing apis and private functions  in all of Totem pallets. The tests are to be developed so that they can be executed whenever new functionality is added to ensure that the expected outcomes remain unbroken.

Deliverables are indicated as: 

 `M<numberOfMilestone>.<numberOfDeliverable>.<numberOfTest>.<numberOfCheck>`

### In-scope deliverables for M2

The following pallets have external facing apis and are in-scope for the deliverables. The links will take you to the requirements set out in this document:

#### Mandatory deliverables

01. [pallet-teams](###pallet-teams)

02. [pallet-timekeeping](###pallet-timekeeping)

03. [pallet-transfer](###pallet-transfer)

#### Non-mandatory deliverables

04. [pallet-orders](###pallet-orders)

05. [pallet-funding](###pallet-funding)

06. [pallet-archive](###pallet-archive)

07. [pallet-accounting](###pallet-accounting)

08. [pallet-bonsai](###pallet-bonsai)

09. [pallet-prefunding](###pallet-prefunding)

Totem uses a fork of the Substrate standard Balances module which contains a specific set of locks for our escrow mechanism. The specific new functions are also in-scope.

10. [pallet-balances-totem](###pallet-balances-totem)

#### Non-mandatory application layer tasks

In addition there are a number of application layer tasks that are part of the overall Totem Live Accounting Application Roadmap and should not be considered mandatory as part of the Substrate Builders program, (as there may be unforeseen implementation issues surrounding building an entirely new form of accounting protocols) but are provided here to give an overall picture of workload for the team. 

These application layer tasks are components that will be required to meet the full product beta launch, and contain elements of front-end engineering, as well as blockchain engineering. These tasks are not full specified in this document. 

Specifications for these tasks are created during the course of implementation and stored in the issues list in our public Gitlab repo.

The sequence of delivery considers the known dependencies within these tasks.

#### Headline tasks to be developed in the application layer

11. Product Management

    * This feature is mainly off-chain and local (to the user) management of products and services. It is a development in the User Interface, the remote storage and Bonsai.

12. Inventory Management

    * Coupled with Product Management and Quantity Accounting, this allows products to be selected for sale, transferred to other identites and otherwise managed. 

## Out-of-Scope for M2

---

There are no Totem pallets that are out of scope for this deliverable.

# Deliverable Specifications 

This deliverable involves setting up a mock genesis state and a test files for each pallet as well as defining the expected outcomes for each unit test. 

These will be defined on a case-by-case basis and should include expected "failed" states as well as "success" states.

Additionally unit tests should also be developed for functions inside the `impl` sections of each pallet. This should ensure that there is an expected outcome for each function.

Any features that fail expected outcomes should be created as issues in the relevant gitlab repositories for resolution. Any issues identified should not be considered part of the scope of this Milestone.

Each function listed below should have tests.

## Deliverable M2.1

### pallet-teams

---

Each of the following functions are implicated in this technical deliverable M2.1 in this pallet. 

_**Note:** this pallet used to be called "projects" but was renamed as the functionality was more "team-like". This will be adjusted as part of a larger overhaul or projects/teams functionality but this work is not in-scope for this deliverable._

#### INPUT Tests M2.1.1
```rust 
fn add_new_project(
    origin: OriginFor<T>,
    project_hash: T::Hash,
) -> DispatchResultWithPostInfo
```

**M2.1.1.1** Ensure that the submitted hash reference `hash` does not exist already and is unique to Totem.
**M2.1.1.2** Ensure that the `hash` is not in the deleted list in `DeletedProjects` storage

#### OUTPUT Tests M2.1.1

**M2.1.1.3** Check that the `hash` has the status `open` in `ProjectHashStatus` storage
**M2.1.1.4** Check that the `hash` has the `origin` of the transaction `ProjectHashOwner` storage
**M2.1.1.5** Check that the `hash` is added to the `OwnerProjectsList` storage for the `origin`



#### INPUT Tests M2.1.2
```rust
fn reassign_project(
    origin: OriginFor<T>,
    new_owner: T::AccountId,
    project_hash: T::Hash,
) -> DispatchResultWithPostInfo
```
**M2.1.2.1** Ensure that the `hash` exists.
**M2.1.2.2** Ensure that the `hash` is not deleted.
**M2.1.2.3** Ensure that the `origin` is the `hash` owner.
**M2.1.2.4** Ensure that the `origin` is not the same as the `new_owner`.

#### OUTPUT Tests M2.1.2

**M2.1.2.1** Check that the `hash` has been assigned to the `new_owner` in `ProjectHashOwner` storage.

#### INPUT Tests M2.1.3

```rust
fn set_status_project(
    origin: OriginFor<T>,
    project_hash: T::Hash,
    project_status: ProjectStatus,
) -> DispatchResultWithPostInfo
```
**M2.1.3.1** Ensure that the `hash` exists.
**M2.1.3.2** Ensure that the `hash` is not deleted.
**M2.1.3.3** Ensure that the `origin` is the `hash` owner.
**M2.1.3.4** Ensure that the current project status in `ProjectHashStatus` is `on_hold`, or `abandon` or `closed` and that the `project_status` is `repopen`.

#### OUTPUT Tests M2.1.3

**M2.1.3.1** Check that the `ProjectHashStatus` storage has been assigned to `repoen`.

Note: `set_status_project` will replace the following functions. The test that would be expected for these functions should be implemented on `set_status_project` in addition to the functionality that already exists.

#### INPUT Tests M2.1.4

```rust
fn remove_project(
    origin: OriginFor<T>,
    project_hash: T::Hash,
) -> DispatchResultWithPostInfo
```

**M2.1.4.1** Ensure that the `hash` exists.
**M2.1.4.2** Ensure that the `hash` is not deleted.
**M2.1.4.3** Ensure that the `origin` is the `hash` owner.

#### OUTPUT Tests M2.1.4

**M2.1.4.1** Check that the `ProjectHashStatus` storage has been assigned to `delete`.
**M2.1.4.2** Check that the `hash` is no longer owned by the `origin` in `ProjectHashOwner` storage
**M2.1.4.3** Check that the `hash` is removed from the `OwnerProjectsList` storage for the `origin`
**M2.1.4.4** Check that the `hash` is added to the `DeletedProjects` storage for the `origin`

#### INPUT Tests M2.1.5
```rust
fn close_project(
    origin: OriginFor<T>,
    project_hash: T::Hash,
) -> DispatchResultWithPostInfo
```

**M2.1.5.1** Ensure that the `hash` exists.
**M2.1.5.2** Ensure that the `hash` is not deleted.
**M2.1.5.3** Ensure that the `origin` is the `hash` owner.



#### OUTPUT Tests M2.1.4

**M2.1.5.1** Check that the `ProjectHashStatus` storage has been assigned to `close`.



#### Deprecated code

The following function has been deprecated as the functionality is included in `set_status_project` and is removed from scope:

```rust
fn reopen_project(
    origin: OriginFor<T>,
    project_hash: T::Hash,
) -> DispatchResultWithPostInfo
```

## Deliverable M2.2

### pallet-timekeeping

---

Each of the following functions are implicated in this technical deliverable M1.2 in this pallet. 

_**Note 1 :** this pallet is closely tied to the former "projects" pallet, now called `pallet-teams`. This will be adjusted as part of a larger overhaul or projects/teams functionality but this work is not in-scope for this deliverable._

#### INPUT Tests M2.2.1

```rust 
fn notify_project_worker(
    origin: OriginFor<T>,
    worker: T::AccountId,
    project_hash: T::Hash,
) -> DispatchResultWithPostInfo

```
#### OUTPUT Tests M2.2.1




```rust 
fn worker_acceptance_project(
    origin: OriginFor<T>,
    project_hash: T::Hash,
    accepted: AcceptAssignedStatus,
) -> DispatchResultWithPostInfo
```
```rust 
fn submit_time(
    origin: OriginFor<T>,
    project_hash: T::Hash,
    input_time_hash: T::Hash,
    submit_status: StatusOfTimeRecord,
    _reason_for_change: ReasonCodeStruct,
    number_of_blocks: NumberOfBlocks,
    _posting_period: PostingPeriod,
    start_block_number: StartOrEndBlockNumber,
    end_block_number: StartOrEndBlockNumber,
    break_counter: NumberOfBreaks,
) -> DispatchResultWithPostInfo
```
```rust 
fn authorise_time(
    origin: OriginFor<T>,
    _worker: T::AccountId,
    project_hash: T::Hash,
    input_time_hash: T::Hash,
    status_of_record: StatusOfTimeRecord,
    _reason: ReasonCodeStruct,
) -> DispatchResultWithPostInfo
```

_**Note 2 :** There are also a number of WIP functions that are not yet completed and so cannot be fully measured for weighting. These are out-of-scope for this deliverable, until they have been developed. For completeness these are as follows:_

```rust
fn pay_time(
    origin: OriginFor<T>,
    _project_hash: T::Hash,
    _input_time_hash: T::Hash,
) -> DispatchResultWithPostInfo 

fn lock_time_record(
    _origin: OriginFor<T>,
    _project_hash: T::Hash,
    _input_time_hash: T::Hash,
) -> DispatchResultWithPostInfo

fn unlock_time_record(
    _origin: OriginFor<T>,
    _project_hash: T::Hash,
    _input_time_hash: T::Hash,
) -> DispatchResultWithPostInfo 

fn ban_worker(
    _origin: OriginFor<T>,
    _project_hash: T::Hash,
    _worker: T::AccountId,
) -> DispatchResultWithPostInfo 

fn unban_worker(
    _origin: OriginFor<T>,
    _project_hash: T::Hash,
    _worker: T::AccountId,
) -> DispatchResultWithPostInfo
```


## Deliverable M2.3

### pallet-transfer

---

This pallet is still a WIP but should be measured as is. The remaining tasks on this pallet is to record the accounting correctly for each transfer. This pallet exists as a wrapper to the standard Substrate implementation of balance transfer function so that we can add accounting and off-line transaction tracking functionality.

```rust
fn transfer(
    origin: OriginFor<T>,
    to: T::AccountId,
    #[pallet::compact] payment_amount: T::Balance,
    tx_uid: T::Hash,
) -> DispatchResultWithPostInfo
```

## Deliverable M2.4

### pallet-orders

---

Each of the following functions are implicated in this technical deliverable M1.4 in this pallet. 


```rust
fn delete_order(
    origin: OriginFor<T>, 
    tx_keys_medium: TXKeysM<T::Hash>
) -> DispatchResultWithPostInfo
```

```rust 
fn create_order(
    origin: OriginFor<T>,
    approver: T::AccountId,
    fulfiller: T::AccountId,
    buy_or_sell: u16,
    total_amount: i128,
    market_order: bool,
    order_type: u16,
    deadline: u32,
    due_date: u32,
    order_items: Vec<OrderItem<T::Hash>>,
    tx_keys_large: TXKeysL<T::Hash>,
) -> DispatchResultWithPostInfo
```
```rust 
fn create_spfso(
    origin: OriginFor<T>,
    approver: T::AccountId,
    fulfiller: T::AccountId,
    buy_or_sell: u16,               
    total_amount: i128,             
    market_order: bool,             
    order_type: u16,                
    deadline: u32,                  
    due_date: u32,                  
    order_item: OrderItem<T::Hash>,
    bonsai_token: T::Hash,
    tx_uid: T::Hash,
) -> DispatchResultWithPostInfo
```
```rust 
fn change_spfso(
    origin: OriginFor<T>,
    approver: T::AccountId,
    fulfiller: T::AccountId,
    amount: i128,
    deadline: u32,
    due_date: u32,
    order_item: OrderItem<T::Hash>,
    record_id: T::Hash,
    bonsai_token: T::Hash,
    tx_uid: T::Hash,
) -> DispatchResultWithPostInfo
```

```rust 
fn change_approval(
    origin: OriginFor<T>,
    h: T::Hash,
    s: ApprovalStatus,
    b: T::Hash,
    tx_uid: T::Hash,
) -> DispatchResultWithPostInfo
```
```rust 
fn handle_spfso(
    origin: OriginFor<T>,
    h: T::Hash,
    s: OrderStatus,
    tx_uid: T::Hash,
) -> DispatchResultWithPostInfo
```

## Deliverable M2.5

### pallet-funding

---

Each of the following functions are implicated in this technical deliverable M1.5 in this pallet.

```rust
fn set_controller_account(
    origin: OriginFor<T>, 
    controller: T::AccountId
) -> DispatchResultWithPostInfo 
```
```rust 
fn set_transfer_status(
    origin: OriginFor<T>
) -> DispatchResultWithPostInfo
```
```rust 
fn mint_coins(
    origin: OriginFor<T>, 
    quantity: u128
) -> DispatchResultWithPostInfo
```
```rust 
fn rebalance_issued_coins(
    origin: OriginFor<T>, 
    amount: u128
    ) -> DispatchResultWithPostInfo
```
```rust 
fn distribute(
    origin: Origi#nFor<T>, 
    to: T::AccountId, 
    amount: u128) -> DispatchResultWithPostInfo
```
```rust 
fn transfer(
    origin: OriginFor<T>, 
    to: T::AccountId, 
    amount: u128) -> DispatchResultWithPostInfo
```

## Deliverable M2.6

### pallet-archive

---

Only one function is implicated in this technical deliverable M2.6 in this pallet. 

```rust 
fn archive_record(
    origin: OriginFor<T>,
    record_type: RecordType,
    bonsai_token: T::Hash,
    archive: bool,
) -> DispatchResultWithPostInfo 
```